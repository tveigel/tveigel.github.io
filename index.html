<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mein Putzplan</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Firebase SDK (compat for simplicity) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <!-- Local Firebase config -->
    <script src="firebase-config.js"></script>

    <style>
        :root {
            --bg: #f8f6f3;
            --card-bg: #ffffff;
            --border: #e0dcd7;
            --text: #2c2c2c;
            --text-light: #6b6560;
            --accent: #8b7e74;
            --accent-light: #c4b8ad;
            --hover: #f0ece7;
            --danger: #c0736e;
            --danger-hover: #a85a55;
            --success: #7a9e7e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }

        /* â”€â”€ TOOLBAR â”€â”€ */
        .toolbar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            box-shadow: 0 1px 4px rgba(0,0,0,.06);
        }
        .toolbar-title {
            font-family: 'Dancing Script', cursive;
            font-size: 1.6rem;
            font-weight: 700;
            margin-right: auto;
            color: var(--accent);
        }
        .toolbar-status {
            font-size: .72rem;
            color: var(--text-light);
            padding: 4px 10px;
            border-radius: 12px;
            background: var(--hover);
        }
        .toolbar-status.connected { color: var(--success); }
        .toolbar-status.error { color: var(--danger); }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text);
            font-size: .82rem;
            font-weight: 500;
            cursor: pointer;
            transition: all .15s;
            font-family: inherit;
        }
        .btn:hover { background: var(--hover); border-color: var(--accent-light); }
        .btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
        .btn-primary:hover { background: #7a6e64; }
        .btn-danger { color: var(--danger); border-color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: #fff; }
        .btn-sm { padding: 4px 10px; font-size: .75rem; }
        .btn svg { width: 16px; height: 16px; }

        /* â”€â”€ MAIN LAYOUT â”€â”€ */
        .main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 28px 24px 60px;
        }

        /* â”€â”€ HEADER â”€â”€ */
        .plan-header {
            display: flex;
            align-items: flex-end;
            gap: 20px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }
        .plan-title {
            font-family: 'Dancing Script', cursive;
            font-size: 2.8rem;
            font-weight: 700;
            color: var(--text);
        }
        .month-input {
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            padding: 6px 12px;
            border: none;
            border-bottom: 2px solid var(--border);
            background: transparent;
            color: var(--text);
            width: 200px;
            outline: none;
            transition: border-color .2s;
        }
        .month-input:focus { border-bottom-color: var(--accent); }
        .plan-icon {
            margin-left: auto;
            font-size: 2.8rem;
            opacity: .6;
        }

        /* â”€â”€ PLAN BODY â”€â”€ */
        .plan-body {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 24px;
            align-items: start;
        }
        .plan-col {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .plan-col-left {
            min-width: 0;
        }
        .plan-col-right {
            min-width: 0;
        }

        /* â”€â”€ SECTION CARD â”€â”€ */
        .section {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px 24px;
            position: relative;
        }
        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }
        .section-title-input {
            font-family: 'Dancing Script', cursive;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            border: none;
            border-bottom: 1px dashed var(--border);
            background: transparent;
            outline: none;
            width: 100%;
            flex: 1;
        }
        .section-title-input:focus { border-bottom-color: var(--accent); }
        .section-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
            align-items: center;
        }
        .icon-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all .15s;
            font-size: 1rem;
        }
        .icon-btn:hover { background: var(--hover); color: var(--text); }
        .icon-btn.danger:hover { background: #fce8e6; color: var(--danger); }

        /* â”€â”€ CATEGORY â”€â”€ */
        .category { margin-bottom: 18px; }
        .category:last-child { margin-bottom: 0; }
        .category-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .category-name-input {
            font-weight: 600;
            font-size: .9rem;
            color: var(--text);
            border: none;
            border-bottom: 1px dashed transparent;
            background: transparent;
            outline: none;
            font-family: inherit;
            flex: 1;
        }
        .category-name-input:focus { border-bottom-color: var(--accent); }

        /* â”€â”€ TASK ROW â”€â”€ */
        .task-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 3px 0;
            border-radius: 4px;
        }
        .task-row:hover .row-actions { opacity: 1; }
        .task-label-input {
            font-size: .85rem;
            color: var(--text-light);
            border: none;
            border-bottom: 1px dashed transparent;
            background: transparent;
            outline: none;
            font-family: inherit;
            flex: 1;
            min-width: 0;
        }
        .task-label-input:focus { border-bottom-color: var(--accent-light); }
        .checkboxes {
            display: flex;
            gap: 3px;
            flex-shrink: 0;
        }
        .cb {
            width: 20px;
            height: 20px;
            border: 1.5px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .15s;
            background: #fff;
            flex-shrink: 0;
        }
        .cb:hover { border-color: var(--accent); }
        .cb.checked {
            background: var(--accent);
            border-color: var(--accent);
        }
        .cb.checked::after {
            content: 'âœ“';
            color: #fff;
            font-size: 13px;
            font-weight: 700;
            line-height: 1;
        }
        .row-actions {
            display: flex;
            gap: 2px;
            opacity: 0;
            transition: opacity .15s;
            flex-shrink: 0;
        }
        .row-actions .icon-btn {
            width: 24px;
            height: 24px;
            font-size: .75rem;
        }

        /* â”€â”€ DAILY TABLE â”€â”€ */
        .daily-table-wrapper { overflow-x: auto; }
        .daily-table {
            width: 100%;
            border-collapse: collapse;
            font-size: .78rem;
        }
        .daily-table th {
            padding: 4px 2px;
            font-weight: 500;
            color: var(--text-light);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            text-align: center;
        }
        .daily-table th.col-header {
            height: 130px;
            vertical-align: bottom;
            padding: 0 2px 8px;
            font-size: .72rem;
            position: relative;
        }
        .daily-table th.col-header .col-header-inner {
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
            height: 100%;
        }
        .daily-table th.col-header .col-header-text {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            font-size: .72rem;
            font-weight: 500;
            white-space: nowrap;
            text-align: left;
        }
        .daily-table th.col-header .col-remove-btn {
            position: absolute;
            top: 2px;
            right: 0;
            width: 16px;
            height: 16px;
            border: none;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: .55rem;
            transition: all .15s;
            opacity: 0;
        }
        .daily-table th.col-header:hover .col-remove-btn { opacity: 1; }
        .daily-table th.col-header .col-remove-btn:hover {
            background: #fce8e6;
            color: var(--danger);
        }
        .daily-table td {
            text-align: center;
            padding: 3px 2px;
            border-bottom: 1px solid #f0ece7;
        }
        .daily-table td:first-child {
            text-align: center;
            font-weight: 500;
            color: var(--text-light);
            width: 30px;
        }
        .daily-table .cb {
            width: 18px;
            height: 18px;
            margin: 0 auto;
        }

        /* â”€â”€ ADD BUTTONS â”€â”€ */
        .add-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            margin-top: 8px;
            font-size: .78rem;
            color: var(--accent);
            border: 1px dashed var(--accent-light);
            border-radius: 6px;
            background: transparent;
            cursor: pointer;
            font-family: inherit;
            transition: all .15s;
        }
        .add-btn:hover {
            background: var(--hover);
            border-color: var(--accent);
        }

        /* â”€â”€ MODAL â”€â”€ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.3);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--card-bg);
            border-radius: 14px;
            padding: 28px;
            max-width: 480px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,.15);
        }
        .modal h3 {
            font-family: 'Dancing Script', cursive;
            font-size: 1.5rem;
            margin-bottom: 16px;
        }
        .modal label {
            font-size: .85rem;
            font-weight: 500;
            display: block;
            margin-bottom: 4px;
            color: var(--text-light);
        }
        .modal input, .modal select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: .9rem;
            font-family: inherit;
            margin-bottom: 14px;
            outline: none;
        }
        .modal input:focus, .modal select:focus { border-color: var(--accent); }
        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 8px;
        }

        /* â”€â”€ CONFIRM BAR â”€â”€ */
        .confirm-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: #fef7f6;
            border: 1px solid #f0c8c4;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: .82rem;
            animation: fadeSlideIn .2s ease;
        }
        .confirm-bar span { flex: 1; color: var(--danger); font-weight: 500; }
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(-6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* â”€â”€ FIREBASE SETUP SCREEN (HIDDEN) â”€â”€ */
        .setup-screen { display: none; }

        /* â”€â”€ PRINT â”€â”€ */
        @media print {
            .toolbar, .section-actions, .row-actions,
            .add-btn, .icon-btn, .no-print,
            .confirm-bar, .col-remove-btn { display: none !important; }

            body { background: #fff; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 9px; }
            .main { padding: 0; max-width: 100%; }

            .plan-header { margin-bottom: 12px; }
            .plan-title { font-size: 2rem; }
            .plan-icon { font-size: 2rem; }
            .month-input { font-size: .85rem; }

            .plan-body {
                grid-template-columns: auto 1fr;
                gap: 8px 12px;
            }
            .plan-col { gap: 8px; }

            .section {
                border: 1px solid #ccc;
                break-inside: avoid;
                page-break-inside: avoid;
                padding: 10px 12px;
                border-radius: 6px;
            }
            .section-title-input {
                font-size: 1.3rem;
                border-bottom: none !important;
                margin-bottom: 4px;
            }
            .section-header { margin-bottom: 8px; }

            .category { margin-bottom: 10px; }
            .category-name-input {
                font-size: .78rem;
                border-bottom: none !important;
            }
            .task-label-input {
                font-size: .72rem;
                border-bottom: none !important;
            }
            .task-row { padding: 1.5px 0; gap: 4px; }
            .checkboxes { gap: 2px; }
            .cb {
                width: 14px;
                height: 14px;
                border-color: #999;
                border-radius: 2px;
                border-width: 1px;
            }
            .cb.checked {
                background: #555 !important;
                border-color: #555 !important;
            }
            .cb.checked::after { font-size: 9px; }

            .month-input { border-bottom: none !important; }

            /* Daily table compact */
            .daily-table { font-size: .65rem; }
            .daily-table th.col-header { height: 90px; padding-bottom: 4px; }
            .daily-table th.col-header .col-header-text { font-size: .6rem; }
            .daily-table th { padding: 2px 1px; font-size: .6rem; }
            .daily-table td { padding: 1.5px 1px; }
            .daily-table .cb { width: 13px; height: 13px; }

            @page { margin: 1cm; size: A4; }
        }

        /* â”€â”€ RESPONSIVE â”€â”€ */
        @media (max-width: 800px) {
            .plan-body { grid-template-columns: 1fr; }
            .plan-title { font-size: 2rem; }
        }
    </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  MAIN APP                                         -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="appContainer">

    <!-- TOOLBAR -->
    <div class="toolbar">
        <span class="toolbar-title">âœ¨ Putzplan Creator</span>
        <span id="syncStatus" class="toolbar-status">Lokal</span>
        <button class="btn btn-sm" onclick="showAddSectionModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Bereich
        </button>
        <button class="btn btn-sm" onclick="addDailySection()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            TÃ¤gliche Tabelle
        </button>
        <button class="btn btn-sm" onclick="resetAllChecks()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
            Reset
        </button>
        <button class="btn btn-sm btn-primary" onclick="window.print()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
            Drucken
        </button>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main">
        <div class="plan-header">
            <span class="plan-title">Mein Putzplan</span>
            <div>
                <label style="font-size:.75rem;color:var(--text-light);">Monat:</label>
                <input type="text" class="month-input" id="monthInput" placeholder="z.B. Februar 2026">
            </div>
            <span class="plan-icon">ğŸ§¹</span>
        </div>
        <div class="plan-body" id="planBody"></div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  MODALS                                           -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Add Section -->
<div class="modal-overlay" id="addSectionModal">
    <div class="modal">
        <h3>Neuen Bereich hinzufÃ¼gen</h3>
        <label>Name</label>
        <input type="text" id="newSectionName" placeholder="z.B. WÃ¶chentlich">
        <label>Checkboxen pro Aufgabe</label>
        <input type="number" id="newSectionBoxes" value="4" min="1" max="31">
        <div class="modal-actions">
            <button class="btn" onclick="closeModal('addSectionModal')">Abbrechen</button>
            <button class="btn btn-primary" onclick="confirmAddSection()">HinzufÃ¼gen</button>
        </div>
    </div>
</div>

<!-- Add Daily Column -->
<div class="modal-overlay" id="addColModal">
    <div class="modal">
        <h3>Neue Spalte hinzufÃ¼gen</h3>
        <label>Gruppenname (z.B. KÃ¼che & Essbereich)</label>
        <input type="text" id="newColGroup" placeholder="z.B. KÃ¼che & Essbereich">
        <label>Aufgabenname</label>
        <input type="text" id="newColName" placeholder="z.B. KÃ¼che aufrÃ¤umen">
        <input type="hidden" id="newColSection">
        <div class="modal-actions">
            <button class="btn" onclick="closeModal('addColModal')">Abbrechen</button>
            <button class="btn btn-primary" onclick="confirmAddCol()">HinzufÃ¼gen</button>
        </div>
    </div>
</div>

<!-- Confirm Dialog Modal -->
<div class="modal-overlay" id="confirmModal">
    <div class="modal" style="max-width:360px;text-align:center;">
        <h3 id="confirmTitle">Bist du sicher?</h3>
        <p id="confirmMessage" style="font-size:.9rem;color:var(--text-light);margin-bottom:20px;"></p>
        <div class="modal-actions" style="justify-content:center;">
            <button class="btn" onclick="closeModal('confirmModal')">Abbrechen</button>
            <button class="btn btn-danger" id="confirmYesBtn">Ja, lÃ¶schen</button>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sid() { return 's' + Math.random().toString(36).substr(2, 9); }
function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEFAULT DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createDefaultData() {
    return {
        month: '',
        sections: [
            {
                id: sid(), type: 'daily', title: 'TÃ¤glich', days: 31,
                columns: [
                    { id: sid(), group: 'KÃ¼che & Essbereich', name: 'KÃ¼che aufrÃ¤umen' },
                    { id: sid(), group: 'KÃ¼che & Essbereich', name: 'Tisch abwischen' },
                    { id: sid(), group: 'KÃ¼che & Essbereich', name: 'SpÃ¼lmaschine ein-/ausrÃ¤umen' },
                    { id: sid(), group: 'KÃ¼che & Essbereich', name: 'MÃ¼ll raustragen' },
                    { id: sid(), group: 'KÃ¼che & Essbereich', name: 'Staubsaugen' },
                    { id: sid(), group: 'KÃ¼che & Essbereich', name: 'SpÃ¼lbecken reinigen' },
                    { id: sid(), group: 'Schlafzimmer', name: 'Bett machen' },
                    { id: sid(), group: 'Schlafzimmer', name: 'LÃ¼ften' },
                ],
                checked: {}
            },
            {
                id: sid(), type: 'weekly', title: 'WÃ¶chentlich', boxes: 4,
                categories: [
                    { id: sid(), name: 'Allgemein', tasks: [
                        { id: sid(), name: 'Staub wischen' },
                        { id: sid(), name: 'Staubsaugen' },
                        { id: sid(), name: 'BÃ¶den reinigen' },
                        { id: sid(), name: 'WÃ¤sche waschen' },
                        { id: sid(), name: 'BÃ¼geln' },
                        { id: sid(), name: 'TÃ¼rklinken abwischen' },
                        { id: sid(), name: 'Blumen giessen' },
                    ]},
                    { id: sid(), name: 'KÃ¼che & Essbereich', tasks: [
                        { id: sid(), name: 'KÃ¼hlschrank aussortieren' },
                        { id: sid(), name: 'MÃ¼lleimer reinigen' },
                        { id: sid(), name: 'Fliesen reinigen' },
                    ]},
                    { id: sid(), name: 'Bad & WC', tasks: [
                        { id: sid(), name: 'Toilette reinigen' },
                        { id: sid(), name: 'Waschbecken reinigen' },
                        { id: sid(), name: 'Spiegel putzen' },
                        { id: sid(), name: 'Dusche reinigen' },
                        { id: sid(), name: 'Badewanne reinigen' },
                        { id: sid(), name: 'MÃ¼ll raustragen' },
                        { id: sid(), name: 'HandtÃ¼cher waschen' },
                    ]}
                ], checked: {}
            },
            {
                id: sid(), type: 'weekly', title: '2-WÃ¶chentlich', boxes: 2,
                categories: [
                    { id: sid(), name: 'Schlafzimmer', tasks: [
                        { id: sid(), name: 'BettwÃ¤sche wechseln' },
                    ]}
                ], checked: {}
            },
            {
                id: sid(), type: 'weekly', title: 'Monatlich', boxes: 1,
                categories: [
                    { id: sid(), name: 'Allgemein', tasks: [
                        { id: sid(), name: 'HeizkÃ¶rper reinigen' },
                        { id: sid(), name: 'SchrÃ¤nke aufrÃ¤umen' },
                        { id: sid(), name: 'MÃ¶bel und Polster sÃ¤ubern' },
                        { id: sid(), name: 'Aussortieren & Ausmisten' },
                        { id: sid(), name: 'Dekorationen abstauben' },
                        { id: sid(), name: 'Blumen dÃ¼ngen' },
                    ]},
                    { id: sid(), name: 'KÃ¼che & Essbereich', tasks: [
                        { id: sid(), name: 'KÃ¼chengerÃ¤te reinigen' },
                        { id: sid(), name: 'Wasserkocher entkalken' },
                        { id: sid(), name: 'Kaffeemaschine entkalken' },
                        { id: sid(), name: 'KÃ¼hlschrank putzen' },
                    ]},
                    { id: sid(), name: 'Bad & WC', tasks: [
                        { id: sid(), name: 'Badfliesen reinigen' },
                    ]}
                ], checked: {}
            }
        ]
    };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let data = null;
let db = null;
let docRef = null;
let unsubscribe = null;
let saveTimeout = null;
let firestoreReady = false;
let suppressNextSnapshot = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initApp() {
    // The firebaseConfig and documentId are now expected to be in firebase-config.js
    if (typeof firebaseConfig !== 'undefined' && firebaseConfig.apiKey) {
        try {
            initFirestore(firebaseConfig, documentId || 'default-putzplan');
        } catch (e) {
            console.error('Firebase init failed:', e);
            startLocal();
        }
    } else {
        console.warn("Firebase config not found. Running in local mode.");
        startLocal();
    }
}

function startLocal() {
    try {
        const saved = localStorage.getItem('putzplan');
        data = saved ? JSON.parse(saved) : createDefaultData();
    } catch { data = createDefaultData(); }
    document.getElementById('appContainer').style.display = '';
    updateSyncStatus('local');
    render();
}

function initFirestore(config, docId) {
    try {
        if (!firebase.apps.length) firebase.initializeApp(config);
        db = firebase.firestore();
        docRef = db.collection('putzplan').doc(docId);
        updateSyncStatus('connecting');
        document.getElementById('appContainer').style.display = '';

        unsubscribe = docRef.onSnapshot(
            (doc) => {
                firestoreReady = true;
                if (suppressNextSnapshot) { suppressNextSnapshot = false; return; }
                if (doc.exists) {
                    data = doc.data();
                    (data.sections || []).forEach(s => { if (!s.checked) s.checked = {}; });
                    localStorage.setItem('putzplan', JSON.stringify(data));
                    updateSyncStatus('connected');
                    render();
                } else {
                    const local = localStorage.getItem('putzplan');
                    data = local ? JSON.parse(local) : createDefaultData();
                    docRef.set(data);
                    updateSyncStatus('connected');
                    render();
                }
            },
            (error) => {
                console.error('Firestore error:', error);
                updateSyncStatus('error');
                if (!data) startLocal();
            }
        );
    } catch (e) {
        console.error('Firebase init error:', e);
        startLocal();
    }
}

function updateSyncStatus(status) {
    const el = document.getElementById('syncStatus');
    if (!el) return;
    el.className = 'toolbar-status';
    switch (status) {
        case 'local': el.textContent = 'ğŸ’¾ Nur lokal'; break;
        case 'connecting': el.textContent = 'ğŸ”„ Verbinde...'; break;
        case 'connected': el.textContent = 'ğŸŸ¢ Synchronisiert'; el.classList.add('connected'); break;
        case 'saving': el.textContent = 'ğŸ”„ Speichert...'; break;
        case 'error': el.textContent = 'ğŸ”´ Fehler'; el.classList.add('error'); break;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAVE (debounced)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function save() {
    localStorage.setItem('putzplan', JSON.stringify(data));
    if (firestoreReady && docRef) {
        if (saveTimeout) clearTimeout(saveTimeout);
        updateSyncStatus('saving');
        saveTimeout = setTimeout(() => {
            suppressNextSnapshot = true;
            docRef.set(JSON.parse(JSON.stringify(data))).then(() => {
                updateSyncStatus('connected');
            }).catch(err => {
                console.error('Save error:', err);
                suppressNextSnapshot = false;
                updateSyncStatus('error');
            });
        }, 800);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
    if (!data) return;
    const monthInput = document.getElementById('monthInput');
    if (monthInput) monthInput.value = data.month || '';
    const body = document.getElementById('planBody');
    if (!body) return;
    body.innerHTML = '';

    // Separate daily and non-daily sections
    const dailySections = data.sections.filter(s => s.type === 'daily');
    const otherSections = data.sections.filter(s => s.type !== 'daily');

    // Left column: daily tables
    let leftCol = '<div class="plan-col plan-col-left">';
    dailySections.forEach(sec => { leftCol += renderDailySection(sec); });
    leftCol += '</div>';

    // Right column: weekly / biweekly / monthly
    let rightCol = '<div class="plan-col plan-col-right">';
    otherSections.forEach(sec => { rightCol += renderWeeklySection(sec); });
    rightCol += '</div>';

    body.innerHTML = leftCol + rightCol;
    bindEvents();
}

// â”€â”€ Weekly / Biweekly / Monthly â”€â”€
function renderWeeklySection(sec) {
    if (!sec.checked) sec.checked = {};
    let cats = '';
    (sec.categories || []).forEach(cat => {
        let tasks = '';
        (cat.tasks || []).forEach(t => {
            let boxes = '';
            for (let b = 0; b < sec.boxes; b++) {
                const key = `${t.id}_${b}`;
                const checked = sec.checked[key] ? ' checked' : '';
                boxes += `<div class="cb${checked}" data-section="${sec.id}" data-key="${key}"></div>`;
            }
            tasks += `
                <div class="task-row">
                    <input class="task-label-input" value="${esc(t.name)}" 
                           data-section="${sec.id}" data-cat="${cat.id}" data-task="${t.id}" data-field="taskname">
                    <div class="checkboxes">${boxes}</div>
                    <div class="row-actions no-print">
                        <button class="icon-btn danger" title="Aufgabe entfernen" 
                                data-action="removeTask" data-section="${sec.id}" data-cat="${cat.id}" data-task="${t.id}">âœ•</button>
                    </div>
                </div>`;
        });
        cats += `
            <div class="category">
                <div class="category-header">
                    <input class="category-name-input" value="${esc(cat.name)}"
                           data-section="${sec.id}" data-cat="${cat.id}" data-field="catname">
                    <button class="icon-btn danger no-print" title="Kategorie entfernen"
                            data-action="removeCat" data-section="${sec.id}" data-cat="${cat.id}" style="flex-shrink:0;">âœ•</button>
                </div>
                ${tasks}
                <button class="add-btn no-print" data-action="addTask" data-section="${sec.id}" data-cat="${cat.id}">+ Aufgabe</button>
            </div>`;
    });

    return `
        <div class="section" data-section="${sec.id}">
            <div class="section-header">
                <input class="section-title-input" value="${esc(sec.title)}"
                       data-section="${sec.id}" data-field="sectiontitle">
                <div class="section-actions no-print">
                    <label style="font-size:.7rem;color:var(--text-light);display:flex;align-items:center;gap:4px;" title="Checkboxen pro Aufgabe">
                        â˜‘
                        <input type="number" value="${sec.boxes}" min="1" max="31"
                               data-section="${sec.id}" data-field="boxes"
                               style="width:40px;padding:2px 4px;border:1px solid var(--border);border-radius:4px;font-size:.75rem;font-family:inherit;outline:none;text-align:center;">
                    </label>
                    <button class="icon-btn" title="Kategorie hinzufÃ¼gen"
                            data-action="addCat" data-section="${sec.id}">ï¼‹</button>
                    <button class="icon-btn danger" title="Bereich lÃ¶schen"
                            data-action="removeSection" data-section="${sec.id}">ğŸ—‘</button>
                </div>
            </div>
            ${cats}
            <button class="add-btn no-print" data-action="addCat" data-section="${sec.id}">+ Kategorie</button>
        </div>`;
}

// â”€â”€ Daily table â”€â”€
function renderDailySection(sec) {
    if (!sec.checked) sec.checked = {};
    const groups = [];
    const groupMap = {};
    (sec.columns || []).forEach(col => {
        if (!groupMap[col.group]) {
            groupMap[col.group] = { name: col.group, cols: [] };
            groups.push(groupMap[col.group]);
        }
        groupMap[col.group].cols.push(col);
    });

    let groupHeaderCells = '<th style="border-bottom:none;"></th>';
    groups.forEach(g => {
        groupHeaderCells += `<th colspan="${g.cols.length}" style="text-align:center;font-size:.72rem;font-weight:600;padding:6px 4px;border-bottom:none;color:var(--text);">${esc(g.name)}</th>`;
    });

    let colHeaderCells = '<th style="border-bottom:2px solid var(--border);"></th>';
    groups.forEach(g => {
        g.cols.forEach(col => {
            colHeaderCells += `<th class="col-header">
                <div class="col-header-inner">
                    <span class="col-header-text">${esc(col.name)}</span>
                </div>
                <button class="col-remove-btn no-print"
                        data-action="removeCol" data-section="${sec.id}" data-col="${col.id}"
                        title="Spalte entfernen">âœ•</button>
            </th>`;
        });
    });

    let rows = '';
    const numDays = sec.days || 31;
    for (let d = 1; d <= numDays; d++) {
        let cells = `<td>${d}</td>`;
        (sec.columns || []).forEach(col => {
            const key = `${col.id}_${d}`;
            const checked = sec.checked[key] ? ' checked' : '';
            cells += `<td><div class="cb${checked}" data-section="${sec.id}" data-key="${key}"></div></td>`;
        });
        rows += `<tr>${cells}</tr>`;
    }

    return `
        <div class="section" data-section="${sec.id}">
            <div class="section-header">
                <input class="section-title-input" value="${esc(sec.title)}"
                       data-section="${sec.id}" data-field="sectiontitle">
                <div class="section-actions no-print">
                    <label style="font-size:.7rem;color:var(--text-light);display:flex;align-items:center;gap:4px;" title="Anzahl Tage">
                        ğŸ“…
                        <input type="number" value="${numDays}" min="1" max="31"
                               data-section="${sec.id}" data-field="days"
                               style="width:40px;padding:2px 4px;border:1px solid var(--border);border-radius:4px;font-size:.75rem;font-family:inherit;outline:none;text-align:center;">
                    </label>
                    <button class="icon-btn" title="Spalte hinzufÃ¼gen"
                            data-action="showAddCol" data-section="${sec.id}">ï¼‹</button>
                    <button class="icon-btn danger" title="Bereich lÃ¶schen"
                            data-action="removeSection" data-section="${sec.id}">ğŸ—‘</button>
                </div>
            </div>
            <div class="daily-table-wrapper">
                <table class="daily-table">
                    <thead>
                        <tr>${groupHeaderCells}</tr>
                        <tr>${colHeaderCells}</tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
            <button class="add-btn no-print" data-action="showAddCol" data-section="${sec.id}" style="margin-top:12px;">+ Spalte hinzufÃ¼gen</button>
        </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EVENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function bindEvents() {
    // Checkboxes
    document.querySelectorAll('.cb').forEach(cb => {
        cb.addEventListener('click', () => {
            const sec = data.sections.find(s => s.id === cb.dataset.section);
            if (!sec) return;
            if (!sec.checked) sec.checked = {};
            const key = cb.dataset.key;
            sec.checked[key] = !sec.checked[key];
            cb.classList.toggle('checked');
            save();
        });
    });

    // Inline edits
    document.querySelectorAll('[data-field="sectiontitle"]').forEach(input => {
        input.addEventListener('input', () => {
            const sec = data.sections.find(s => s.id === input.dataset.section);
            if (sec) { sec.title = input.value; save(); }
        });
    });
    document.querySelectorAll('[data-field="catname"]').forEach(input => {
        input.addEventListener('input', () => {
            const sec = data.sections.find(s => s.id === input.dataset.section);
            const cat = sec && sec.categories ? sec.categories.find(c => c.id === input.dataset.cat) : null;
            if (cat) { cat.name = input.value; save(); }
        });
    });
    document.querySelectorAll('[data-field="taskname"]').forEach(input => {
        input.addEventListener('input', () => {
            const sec = data.sections.find(s => s.id === input.dataset.section);
            const cat = sec && sec.categories ? sec.categories.find(c => c.id === input.dataset.cat) : null;
            const task = cat && cat.tasks ? cat.tasks.find(t => t.id === input.dataset.task) : null;
            if (task) { task.name = input.value; save(); }
        });
    });
    document.querySelectorAll('[data-field="days"]').forEach(input => {
        input.addEventListener('change', () => {
            const sec = data.sections.find(s => s.id === input.dataset.section);
            if (sec) { sec.days = Math.max(1, Math.min(31, parseInt(input.value) || 31)); render(); save(); }
        });
    });
    document.querySelectorAll('[data-field="boxes"]').forEach(input => {
        input.addEventListener('change', () => {
            const sec = data.sections.find(s => s.id === input.dataset.section);
            if (sec) { sec.boxes = Math.max(1, Math.min(31, parseInt(input.value) || 4)); render(); save(); }
        });
    });

    // Month
    const monthEl = document.getElementById('monthInput');
    if (monthEl) {
        monthEl.addEventListener('input', () => { data.month = monthEl.value; save(); });
    }

    // Action buttons
    document.querySelectorAll('[data-action]').forEach(btn => {
        btn.addEventListener('click', handleAction);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleAction(e) {
    e.stopPropagation();
    const btn = e.currentTarget;
    const action = btn.dataset.action;
    const secId = btn.dataset.section;
    const catId = btn.dataset.cat;
    const taskId = btn.dataset.task;
    const colId = btn.dataset.col;

    switch (action) {
        case 'addTask': {
            const sec = data.sections.find(s => s.id === secId);
            const cat = sec.categories.find(c => c.id === catId);
            cat.tasks.push({ id: sid(), name: 'Neue Aufgabe' });
            render(); save();
            break;
        }
        case 'removeTask': {
            const sec = data.sections.find(s => s.id === secId);
            const cat = sec.categories.find(c => c.id === catId);
            cat.tasks = cat.tasks.filter(t => t.id !== taskId);
            render(); save();
            break;
        }
        case 'addCat': {
            const sec = data.sections.find(s => s.id === secId);
            sec.categories.push({ id: sid(), name: 'Neue Kategorie', tasks: [{ id: sid(), name: 'Neue Aufgabe' }] });
            render(); save();
            break;
        }
        case 'removeCat': {
            showConfirmDialog('Kategorie lÃ¶schen?', 'Die Kategorie und alle Aufgaben darin werden entfernt.', () => {
                const sec = data.sections.find(s => s.id === secId);
                sec.categories = sec.categories.filter(c => c.id !== catId);
                render(); save();
            });
            break;
        }
        case 'removeSection': {
            showConfirmDialog('Bereich lÃ¶schen?', 'Der gesamte Bereich wird unwiderruflich entfernt.', () => {
                data.sections = data.sections.filter(s => s.id !== secId);
                render(); save();
            });
            break;
        }
        case 'showAddCol': {
            const sec = data.sections.find(s => s.id === secId);
            const lastGroup = sec.columns && sec.columns.length > 0 ? sec.columns[sec.columns.length - 1].group : '';
            document.getElementById('newColGroup').value = lastGroup;
            document.getElementById('newColName').value = '';
            document.getElementById('newColSection').value = secId;
            openModal('addColModal');
            setTimeout(() => document.getElementById('newColName').focus(), 100);
            break;
        }
        case 'removeCol': {
            showConfirmDialog('Spalte entfernen?', 'Die Spalte und alle zugehÃ¶rigen HÃ¤kchen werden gelÃ¶scht.', () => {
                const sec = data.sections.find(s => s.id === secId);
                sec.columns = sec.columns.filter(c => c.id !== colId);
                render(); save();
            });
            break;
        }
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIRM DIALOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let confirmCallback = null;

function showConfirmDialog(title, message, onConfirm) {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    confirmCallback = onConfirm;
    openModal('confirmModal');
}

document.getElementById('confirmYesBtn').addEventListener('click', () => {
    closeModal('confirmModal');
    if (confirmCallback) { confirmCallback(); confirmCallback = null; }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.classList.remove('active');
    });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOOLBAR ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showAddSectionModal() {
    document.getElementById('newSectionName').value = '';
    document.getElementById('newSectionBoxes').value = '4';
    openModal('addSectionModal');
    setTimeout(() => document.getElementById('newSectionName').focus(), 100);
}

function confirmAddSection() {
    const name = document.getElementById('newSectionName').value.trim() || 'Neuer Bereich';
    const boxes = parseInt(document.getElementById('newSectionBoxes').value) || 4;
    data.sections.push({
        id: sid(), type: 'weekly', title: name, boxes,
        categories: [{ id: sid(), name: 'Allgemein', tasks: [{ id: sid(), name: 'Neue Aufgabe' }] }],
        checked: {}
    });
    closeModal('addSectionModal');
    render(); save();
}

function addDailySection() {
    data.sections.unshift({
        id: sid(), type: 'daily', title: 'TÃ¤glich', days: 31,
        columns: [
            { id: sid(), group: 'Allgemein', name: 'Aufgabe 1' },
            { id: sid(), group: 'Allgemein', name: 'Aufgabe 2' },
        ],
        checked: {}
    });
    render(); save();
}

function confirmAddCol() {
    const secId = document.getElementById('newColSection').value;
    const group = document.getElementById('newColGroup').value.trim() || 'Allgemein';
    const name = document.getElementById('newColName').value.trim() || 'Neue Spalte';
    const sec = data.sections.find(s => s.id === secId);
    if (!sec) return;
    sec.columns.push({ id: sid(), group, name });
    closeModal('addColModal');
    render(); save();
}

function resetAllChecks() {
    showConfirmDialog('Alle HÃ¤kchen zurÃ¼cksetzen?', 'Alle Checkboxen in allen Bereichen werden geleert.', () => {
        data.sections.forEach(sec => { sec.checked = {}; });
        render(); save();
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initApp();
</script>
</body>
</html>
